<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Presensi QR Code</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .attendance-card {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .success-flash {
            animation: flash 0.5s ease-in-out;
        }
        
        @keyframes flash {
            0%, 100% { background-color: rgb(34, 197, 94); }
            50% { background-color: rgb(22, 163, 74); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üì± Sistem Presensi QR</h1>
            <p class="text-gray-600">Scan QR code untuk mencatat kehadiran otomatis</p>
        </div>

        <!-- Scanner Section -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 max-w-2xl mx-auto">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-2">Scanner QR Code</h2>
                <div class="flex items-center justify-center space-x-2 mb-4">
                    <div id="status-indicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                    <span id="status-text" class="text-sm text-gray-600">Kamera tidak aktif</span>
                </div>
            </div>
            
            <div id="qr-reader" class="border-2 border-dashed border-gray-300 rounded-lg"></div>
            
            <div class="flex justify-center space-x-4 mt-6">
                <button id="start-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    üé• Mulai Scan
                </button>
                <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors" disabled>
                    ‚èπÔ∏è Stop Scan
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-green-600" id="total-present">0</div>
                <div class="text-gray-600 mt-1">Total Hadir</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="today-count">0</div>
                <div class="text-gray-600 mt-1">Hari Ini</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-purple-600" id="unique-users">0</div>
                <div class="text-gray-600 mt-1">Pengguna Unik</div>
            </div>
        </div>

        <!-- Recent Attendance -->
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-4xl mx-auto">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6">üìã Presensi Terbaru</h3>
            <div id="attendance-list" class="space-y-3">
                <div class="text-center text-gray-500 py-8">
                    Belum ada data presensi. Mulai scan QR code!
                </div>
            </div>
            
            <!-- Clear Data Button -->
            <div class="mt-6 text-center">
                <button id="clear-data" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    üóëÔ∏è Hapus Semua Data
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-bold text-green-600 mb-2">Presensi Berhasil!</h3>
            <p id="success-message" class="text-gray-600 mb-4"></p>
            <button id="close-modal" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                OK
            </button>
        </div>
    </div>

    <script>
        class AttendanceSystem {
            constructor() {
                this.html5QrCode = null;
                this.isScanning = false;
                this.attendanceData = this.loadData();
                this.initializeElements();
                this.bindEvents();
                this.updateStatistics();
                this.renderAttendanceList();
            }

            initializeElements() {
                this.startBtn = document.getElementById('start-btn');
                this.stopBtn = document.getElementById('stop-btn');
                this.statusIndicator = document.getElementById('status-indicator');
                this.statusText = document.getElementById('status-text');
                this.attendanceList = document.getElementById('attendance-list');
                this.successModal = document.getElementById('success-modal');
                this.successMessage = document.getElementById('success-message');
                this.closeModal = document.getElementById('close-modal');
                this.clearDataBtn = document.getElementById('clear-data');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.closeModal.addEventListener('click', () => this.hideSuccessModal());
                this.clearDataBtn.addEventListener('click', () => this.clearAllData());
            }

            loadData() {
                const saved = localStorage.getItem('attendanceData');
                return saved ? JSON.parse(saved) : [];
            }

            saveData() {
                localStorage.setItem('attendanceData', JSON.stringify(this.attendanceData));
            }

            async startScanning() {
                try {
                    this.html5QrCode = new Html5Qrcode("qr-reader");
                    
                    await this.html5QrCode.start(
                        { facingMode: "environment" },
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (decodedText, decodedResult) => {
                            this.processQRCode(decodedText);
                        },
                        (errorMessage) => {
                            // Handle scan errors silently
                        }
                    );

                    this.isScanning = true;
                    this.updateScannerStatus(true);
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;

                } catch (err) {
                    alert('Error starting camera: ' + err);
                }
            }

            async stopScanning() {
                if (this.html5QrCode && this.isScanning) {
                    try {
                        await this.html5QrCode.stop();
                        this.html5QrCode.clear();
                        this.isScanning = false;
                        this.updateScannerStatus(false);
                        this.startBtn.disabled = false;
                        this.stopBtn.disabled = true;
                    } catch (err) {
                        console.error('Error stopping scanner:', err);
                    }
                }
            }

            updateScannerStatus(isActive) {
                if (isActive) {
                    this.statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    this.statusText.textContent = 'Kamera aktif - Siap scan';
                } else {
                    this.statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    this.statusText.textContent = 'Kamera tidak aktif';
                }
            }

            processQRCode(qrData) {
                // Parse QR code data (assuming format: "ID:Name" or just "Name")
                let userId, userName;
                
                if (qrData.includes(':')) {
                    [userId, userName] = qrData.split(':');
                } else {
                    userId = qrData;
                    userName = qrData;
                }

                // Check if already present today
                const today = new Date().toDateString();
                const alreadyPresent = this.attendanceData.some(record => 
                    record.userId === userId && 
                    new Date(record.timestamp).toDateString() === today
                );

                if (alreadyPresent) {
                    this.showSuccessModal(`${userName} sudah tercatat hadir hari ini!`, false);
                    return;
                }

                // Add new attendance record
                const attendanceRecord = {
                    id: Date.now(),
                    userId: userId,
                    userName: userName,
                    timestamp: new Date().toISOString(),
                    date: today
                };

                this.attendanceData.unshift(attendanceRecord);
                this.saveData();
                this.updateStatistics();
                this.renderAttendanceList();
                
                this.showSuccessModal(`${userName} berhasil dicatat hadir!`, true);
                
                // Auto-restart scanning after 2 seconds
                setTimeout(() => {
                    this.hideSuccessModal();
                }, 2000);
            }

            showSuccessModal(message, isSuccess) {
                this.successMessage.textContent = message;
                this.successModal.classList.remove('hidden');
                this.successModal.classList.add('flex');
                
                if (isSuccess) {
                    this.successModal.querySelector('.bg-white').classList.add('success-flash');
                }
            }

            hideSuccessModal() {
                this.successModal.classList.add('hidden');
                this.successModal.classList.remove('flex');
                this.successModal.querySelector('.bg-white').classList.remove('success-flash');
            }

            updateStatistics() {
                const totalPresent = this.attendanceData.length;
                const today = new Date().toDateString();
                const todayCount = this.attendanceData.filter(record => 
                    new Date(record.timestamp).toDateString() === today
                ).length;
                const uniqueUsers = new Set(this.attendanceData.map(record => record.userId)).size;

                document.getElementById('total-present').textContent = totalPresent;
                document.getElementById('today-count').textContent = todayCount;
                document.getElementById('unique-users').textContent = uniqueUsers;
            }

            renderAttendanceList() {
                if (this.attendanceData.length === 0) {
                    this.attendanceList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            Belum ada data presensi. Mulai scan QR code!
                        </div>
                    `;
                    return;
                }

                this.attendanceList.innerHTML = this.attendanceData
                    .slice(0, 10) // Show only last 10 records
                    .map(record => {
                        const date = new Date(record.timestamp);
                        const timeString = date.toLocaleTimeString('id-ID');
                        const dateString = date.toLocaleDateString('id-ID');
                        const isToday = date.toDateString() === new Date().toDateString();
                        
                        return `
                            <div class="attendance-card flex items-center justify-between p-4 bg-gray-50 rounded-lg border-l-4 ${isToday ? 'border-green-500' : 'border-blue-500'}">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-gradient-to-r ${isToday ? 'from-green-400 to-green-600' : 'from-blue-400 to-blue-600'} rounded-full flex items-center justify-center text-white font-bold">
                                        ${record.userName.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-800">${record.userName}</div>
                                        <div class="text-sm text-gray-600">ID: ${record.userId}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium text-gray-800">${timeString}</div>
                                    <div class="text-sm text-gray-600">${dateString}</div>
                                    ${isToday ? '<span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full mt-1">Hari ini</span>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
            }

            clearAllData() {
                if (confirm('Apakah Anda yakin ingin menghapus semua data presensi?')) {
                    this.attendanceData = [];
                    this.saveData();
                    this.updateStatistics();
                    this.renderAttendanceList();
                    alert('Semua data presensi telah dihapus!');
                }
            }
        }

        // Initialize the attendance system when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AttendanceSystem();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'964b0d113613d98b',t:'MTc1MzQ0MDE1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
